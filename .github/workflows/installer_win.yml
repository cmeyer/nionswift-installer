name: Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2019]
        python-version: [3.9]

    env:
      product_name: NionSwift-0.15
      product_identifier: Nion_Swift_0_15
      qt_version: 5.15.2
      qt_platform: msvc2019_64
      python_version: 3.9.1

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display Python version
      run: python -c "import sys; print(sys.version)"
    - name: Build
      run: |
        mkdir venv
        python -m venv venv/installer
        venv\installer\Scripts\activate
        python -m pip install --upgrade pip

        pip install aqtinstall
        mkdir Qt
        python -m aqt install --outputdir Qt ${env:qt_version} windows desktop win64_${env:qt_platform} -m qtcore qtgui qtnetwork qtwidgets qtxml
        $ENV:Qt5_DIR = (Get-Item -Path ".\").FullName + "\Qt\${env:qt_version}\${env:qt_platform}\lib\cmake\Qt5"
        pip install numpy
        git clone https://github.com/nion-software/nionui-tool.git
        git clone https://github.com/nion-software/nionswift-tool.git
        Copy-Item nionswift-tool/launcher/Graphics/WinIcon.ico -Destination nionui-tool/launcher/Graphics/WinIcon.ico -Force
        pushd nionui-tool/launcher
        $PYTHON_EXEC = python -c "import sys; print(sys.executable, end='')"
        cmake CMakeLists.txt -DPython3_EXECUTABLE="$PYTHON_EXEC" -DUSE_CONSOLE=OFF
        cmake --build . --config Release
        popd

        $PYTHON_FILE = "python-${env:python_version}-amd64"
        $exePath = Join-Path (Get-Location).path "$PYTHON_FILE.exe"
        (New-Object Net.WebClient).DownloadFile("https://www.python.org/ftp/python/${env:python_version}/$PYTHON_FILE.exe", $exePath)

        cmd /c start /wait "$PYTHON_FILE.exe" /quiet /uninstall

        $PYTHON_39_DIR = Join-Path (Get-Location).path "$PYTHON_FILE"
        cmd /c start /wait "$PYTHON_FILE.exe" /quiet TargetDir=$PYTHON_39_DIR AssociateFiles=0 Shortcuts=0 Include_doc=0 Include_dev=1 Include_launcher=0 InstallLauncherAllUsers=0 Include_tcltk=1 Include_test=0 Include_tools=0
        & ".\$PYTHON_FILE\python.exe" -m pip install wheel
        & ".\$PYTHON_FILE\python.exe" -m venv python-nionswift
        .\python-nionswift\Scripts\activate

        # install latest version of nionswift
        # git clone https://github.com/nion-software/nionutils.git
        # git clone https://github.com/nion-software/niondata.git
        # git clone https://github.com/nion-software/nionui.git
        # git clone https://github.com/nion-software/nionswift.git
        # git clone https://github.com/nion-software/nionswift-io.git
        # git clone https://github.com/nion-software/nionswift-instrumentation-kit.git
        # git clone https://github.com/nion-software/eels-analysis.git nionswift-eels-analysis
        # git clone https://github.com/nion-software/nionswift-usim.git

        # python -m pip install ./nionutils
        # python -m pip install ./niondata
        # python -m pip install ./nionui
        # python -m pip install ./nionswift
        # python -m pip install ./nionswift-instrumentation-kit
        # python -m pip install ./nionswift-eels-analysis
        # python -m pip install ./nionswift-usim
        python -m pip install numpy==1.19.3  # see https://developercommunity.visualstudio.com/content/problem/1207405/fmod-after-an-update-to-windows-2004-is-causing-a.html

        # or the released version
        python -m pip install nionswift nionswift-eels-analysis nionswift-usim

        deactivate

        # pyinstaller --clean --windowed --onedir -d noarchive `
        #   --add-data "venv/installer/Lib/site-packages/nion/swift/model/resources;nion/swift/model/resources" `
        #   --add-data "venv/installer/Lib/site-packages/nion/swift/resources;nion/swift/resources" `
        #   --add-data "venv/installer/Lib/site-packages/nion/ui/resources;nion/ui/resources" `
        #   --exclude-module tkinter --hidden-import nionswift_plugin.none --hidden-import nionswift_plugin.DM_IO `
        #   --hidden-import nionswift_plugin.TIFF_IO --icon nionswift-tool/launcher/Graphics/WinIcon.ico `
        #   --name "${env:product_identifier}" win_runswift.py -y

        mkdir ".\dist\${env:product_identifier}"
        Copy-Item -Recurse -Path .\nionui-tool\launcher\build\Release\* -Destination ".\dist\${env:product_identifier}"
        Copy-Item .\win_toolconfig.toml -Destination ".\dist\${env:product_identifier}\toolconfig.toml"
        Copy-Item .\nionswift-tool\launcher\Artwork\splash_600x400.png -Destination ".\dist\${env:product_identifier}\splash.png"
        Move-Item -Force ".\dist\${env:product_identifier}\NionUILauncher.exe" ".\dist\${env:product_identifier}\${env:product_identifier}.exe"
        Copy-Item -Recurse -Path "$PYTHON_39_DIR\*" -Destination ".\dist\${env:product_identifier}"
        Copy-Item -Recurse -Path .\python-nionswift\Lib\site-packages -Destination ".\dist\${env:product_identifier}\python-nionswift\Lib\site-packages"

        pushd wix
        cmake .\CMakeLists.txt -DVERSION_OVERALL=15 -DVERSION_MAJOR=0 -DVERSION_MINOR=15 -DVERSION_PATCH=0
        cpack
        popd
    - name: Upload Product Zip
      uses: actions/upload-artifact@v2
      with:
        name: ${{ env.product_name }}.zip
        path: dist\${{ env.product_identifier }}
    - name: Upload Product MSI
      uses: actions/upload-artifact@v2
      with:
        name: ${{ env.product_name }}.msi
        path: wix\${{ env.product_name }}.msi
